"use strict";var _interopRequireDefault=require("@babel/runtime-corejs3/helpers/interopRequireDefault");var _defineProperty2=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/define-property"));var _defineProperties=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/define-properties"));var _getOwnPropertyDescriptors=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptors"));var _forEach=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/for-each"));var _getOwnPropertyDescriptor=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptor"));var _filter=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/filter"));var _getOwnPropertySymbols=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-symbols"));var _keys=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/keys"));var _defineProperty3=_interopRequireDefault(require("@babel/runtime-corejs3/helpers/defineProperty"));var _promise=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/promise"));var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime-corejs3/helpers/objectWithoutProperties"));function ownKeys(object,enumerableOnly){var keys=(0,_keys.default)(object);if(_getOwnPropertySymbols.default){var symbols=(0,_getOwnPropertySymbols.default)(object);if(enumerableOnly)symbols=(0,_filter.default)(symbols).call(symbols,function(sym){return(0,_getOwnPropertyDescriptor.default)(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){var _context;(0,_forEach.default)(_context=ownKeys(Object(source),true)).call(_context,function(key){(0,_defineProperty3.default)(target,key,source[key]);});}else if(_getOwnPropertyDescriptors.default){(0,_defineProperties.default)(target,(0,_getOwnPropertyDescriptors.default)(source));}else{var _context2;(0,_forEach.default)(_context2=ownKeys(Object(source))).call(_context2,function(key){(0,_defineProperty2.default)(target,key,(0,_getOwnPropertyDescriptor.default)(source,key));});}}return target;}const Datastore=require("./main/datastore");const Logger=require("./main/logger");const extendDatabaseMethods=require("./extend");const extendLoggerMethods=require("./extend/logger");const dbs={};const compactionInterval=1000*60*60*24;async function createDatabase(config){const{filename,ensureIndex,defaultContent,logger=false}=config,storeOptions=(0,_objectWithoutProperties2.default)(config,["filename","ensureIndex","defaultContent","logger"]);let db=dbs[filename];if(!db){const Store=logger?Logger:Datastore;const instance=await new _promise.default((resolve,reject)=>{let i;i=new Store(_objectSpread({filename,autoload:true,onload:err=>err?reject(err):resolve(i)},storeOptions));});if(logger){dbs[filename]=db=extendLoggerMethods({db,instance});}else{instance.persistence.setAutocompactionInterval(compactionInterval);dbs[filename]=db=extendDatabaseMethods({db,instance});}}if(logger)return db;if(defaultContent&&!(await db.findOne())){if(defaultContent instanceof Function){await defaultContent({db});}else{await db.insert(defaultContent);}}if(ensureIndex){for(let opt of ensureIndex){await db.ensureIndex(opt);}}return db;}module.exports=createDatabase;