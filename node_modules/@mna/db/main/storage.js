"use strict";let fs=require('fs'),mkdirp=require('mkdirp'),asyncWaterfall=require('neo-async/waterfall'),asyncApply=require('neo-async/apply'),path=require('path'),storage={};storage.exists=fs.exists;storage.rename=fs.rename;storage.writeFile=fs.writeFile;storage.unlink=fs.unlink;storage.appendFile=fs.appendFile;storage.readFile=fs.readFile;storage.mkdirp=mkdirp;storage.ensureFileDoesntExist=function(file,callback){storage.exists(file,function(exists){if(!exists){return callback(null);}storage.unlink(file,function(err){return callback(err);});});};storage.flushToStorage=function(options,callback){let filename,flags;if(typeof options==='string'){filename=options;flags='r+';}else{filename=options.filename;flags=options.isDir?'r':'r+';}if(flags==='r'&&(process.platform==='win32'||process.platform==='win64')){return callback(null);}fs.open(filename,flags,function(err,fd){if(err){return callback(err);}fs.fsync(fd,function(errFS){fs.close(fd,function(errC){if(errFS||errC){let e=new Error('Failed to flush to storage');e.errorOnFsync=errFS;e.errorOnClose=errC;return callback(e);}else{return callback(null);}});});});};storage.crashSafeWriteFile=function(filename,data,cb){let callback=cb||function(){},tempFilename=filename+'~';asyncWaterfall([asyncApply(storage.flushToStorage,{filename:path.dirname(filename),isDir:true}),function(cb){storage.exists(filename,function(exists){if(exists){storage.flushToStorage(filename,function(err){return cb(err);});}else{return cb();}});},function(cb){storage.writeFile(tempFilename,data,function(err){return cb(err);});},asyncApply(storage.flushToStorage,tempFilename),function(cb){storage.rename(tempFilename,filename,function(err){return cb(err);});},asyncApply(storage.flushToStorage,{filename:path.dirname(filename),isDir:true})],function(err){return callback(err);});};storage.ensureDatafileIntegrity=function(filename,callback){let tempFilename=filename+'~';storage.exists(filename,function(filenameExists){if(filenameExists){return callback(null);}storage.exists(tempFilename,function(oldFilenameExists){if(!oldFilenameExists){return storage.writeFile(filename,'','utf8',function(err){callback(err);});}storage.rename(tempFilename,filename,function(err){return callback(err);});});});};module.exports=storage;