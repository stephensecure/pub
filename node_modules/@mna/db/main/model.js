"use strict";var _interopRequireDefault=require("@babel/runtime-corejs3/helpers/interopRequireDefault");var _parseInt2=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/parse-int"));var _filter=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/filter"));var _map=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/map"));var _splice=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/splice"));var _slice=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/slice"));var _sort=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/sort"));var _stringify=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/json/stringify"));var _keys=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/keys"));var _forEach=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/for-each"));var _indexOf=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/index-of"));var _context11;let util=require('util'),_=require('underscore'),modifierFunctions={},lastStepModifierFunctions={},comparisonFunctions={},logicalOperators={},arrayComparisonFunctions={};function checkKey(k,v){if(typeof k==='number'){k=k.toString();}if(k[0]==='$'&&!(k==='$$date'&&typeof v==='number')&&!(k==='$$deleted'&&v===true)&&!(k==='$$indexCreated')&&!(k==='$$indexRemoved')){throw new Error('Field names cannot begin with the $ character');}if((0,_indexOf.default)(k).call(k,'.')!==-1){throw new Error('Field names cannot contain a .');}}function checkObject(obj){if(util.isArray(obj)){(0,_forEach.default)(obj).call(obj,function(o){checkObject(o);});}if(typeof obj==='object'&&obj!==null){var _context;(0,_forEach.default)(_context=(0,_keys.default)(obj)).call(_context,function(k){checkKey(k,obj[k]);checkObject(obj[k]);});}}function serialize(obj){let res;res=(0,_stringify.default)(obj,function(k,v){checkKey(k,v);if(v===undefined){return undefined;}if(v===null){return null;}if(typeof this[k].getTime==='function'){return{$$date:this[k].getTime()};}return v;});return res;}function deserialize(rawData){return JSON.parse(rawData,function(k,v){if(k==='$$date'){return new Date(v);}if(typeof v==='string'||typeof v==='number'||typeof v==='boolean'||v===null){return v;}if(v&&v.$$date){return v.$$date;}return v;});}function deepCopy(obj,strictKeys){let res;if(typeof obj==='boolean'||typeof obj==='number'||typeof obj==='string'||obj===null||util.isDate(obj)){return obj;}if(util.isArray(obj)){res=[];(0,_forEach.default)(obj).call(obj,function(o){res.push(deepCopy(o,strictKeys));});return res;}if(typeof obj==='object'){var _context2;res={};(0,_forEach.default)(_context2=(0,_keys.default)(obj)).call(_context2,function(k){if(!strictKeys||k[0]!=='$'&&(0,_indexOf.default)(k).call(k,'.')===-1){res[k]=deepCopy(obj[k],strictKeys);}});return res;}return undefined;}function isPrimitiveType(obj){return typeof obj==='boolean'||typeof obj==='number'||typeof obj==='string'||obj===null||util.isDate(obj)||util.isArray(obj);}function compareNSB(a,b){if(a<b){return-1;}if(a>b){return 1;}return 0;}function compareArrays(a,b){let i,comp;for(i=0;i<Math.min(a.length,b.length);i+=1){comp=compareThings(a[i],b[i]);if(comp!==0){return comp;}}return compareNSB(a.length,b.length);}function compareThings(a,b,_compareStrings){var _context3,_context4;let aKeys,bKeys,comp,i,compareStrings=_compareStrings||compareNSB;if(a===undefined){return b===undefined?0:-1;}if(b===undefined){return a===undefined?0:1;}if(a===null){return b===null?0:-1;}if(b===null){return a===null?0:1;}if(typeof a==='number'){return typeof b==='number'?compareNSB(a,b):-1;}if(typeof b==='number'){return typeof a==='number'?compareNSB(a,b):1;}if(typeof a==='string'){return typeof b==='string'?compareStrings(a,b):-1;}if(typeof b==='string'){return typeof a==='string'?compareStrings(a,b):1;}if(typeof a==='boolean'){return typeof b==='boolean'?compareNSB(a,b):-1;}if(typeof b==='boolean'){return typeof a==='boolean'?compareNSB(a,b):1;}if(util.isDate(a)){return util.isDate(b)?compareNSB(a.getTime(),b.getTime()):-1;}if(util.isDate(b)){return util.isDate(a)?compareNSB(a.getTime(),b.getTime()):1;}if(util.isArray(a)){return util.isArray(b)?compareArrays(a,b):-1;}if(util.isArray(b)){return util.isArray(a)?compareArrays(a,b):1;}aKeys=(0,_sort.default)(_context3=(0,_keys.default)(a)).call(_context3);bKeys=(0,_sort.default)(_context4=(0,_keys.default)(b)).call(_context4);for(i=0;i<Math.min(aKeys.length,bKeys.length);i+=1){comp=compareThings(a[aKeys[i]],b[bKeys[i]]);if(comp!==0){return comp;}}return compareNSB(aKeys.length,bKeys.length);}lastStepModifierFunctions.$set=function(obj,field,value){obj[field]=value;};lastStepModifierFunctions.$unset=function(obj,field,value){delete obj[field];};lastStepModifierFunctions.$push=function(obj,field,value){if(!obj.hasOwnProperty(field)){obj[field]=[];}if(!util.isArray(obj[field])){throw new Error("Can't $push an element on non-array values");}if(value!==null&&typeof value==='object'&&value.$slice&&value.$each===undefined){value.$each=[];}if(value!==null&&typeof value==='object'&&value.$each){var _context5;if((0,_keys.default)(value).length>=3||(0,_keys.default)(value).length===2&&value.$slice===undefined){throw new Error("Can only use $slice in cunjunction with $each when $push to array");}if(!util.isArray(value.$each)){throw new Error("$each requires an array value");}(0,_forEach.default)(_context5=value.$each).call(_context5,function(v){obj[field].push(v);});if(value.$slice===undefined||typeof value.$slice!=='number'){return;}if(value.$slice===0){obj[field]=[];}else{var _context6;let start,end,n=obj[field].length;if(value.$slice<0){start=Math.max(0,n+value.$slice);end=n;}else if(value.$slice>0){start=0;end=Math.min(n,value.$slice);}obj[field]=(0,_slice.default)(_context6=obj[field]).call(_context6,start,end);}}else{obj[field].push(value);}};lastStepModifierFunctions.$addToSet=function(obj,field,value){let addToSet=true;if(!obj.hasOwnProperty(field)){obj[field]=[];}if(!util.isArray(obj[field])){throw new Error("Can't $addToSet an element on non-array values");}if(value!==null&&typeof value==='object'&&value.$each){var _context7;if((0,_keys.default)(value).length>1){throw new Error("Can't use another field in conjunction with $each");}if(!util.isArray(value.$each)){throw new Error("$each requires an array value");}(0,_forEach.default)(_context7=value.$each).call(_context7,function(v){lastStepModifierFunctions.$addToSet(obj,field,v);});}else{var _context8;(0,_forEach.default)(_context8=obj[field]).call(_context8,function(v){if(compareThings(v,value)===0){addToSet=false;}});if(addToSet){obj[field].push(value);}}};lastStepModifierFunctions.$pop=function(obj,field,value){if(!util.isArray(obj[field])){throw new Error("Can't $pop an element from non-array values");}if(typeof value!=='number'){throw new Error(value+" isn't an integer, can't use it with $pop");}if(value===0){return;}if(value>0){var _context9;obj[field]=(0,_slice.default)(_context9=obj[field]).call(_context9,0,obj[field].length-1);}else{var _context10;obj[field]=(0,_slice.default)(_context10=obj[field]).call(_context10,1);}};lastStepModifierFunctions.$pull=function(obj,field,value){let arr,i;if(!util.isArray(obj[field])){throw new Error("Can't $pull an element from non-array values");}arr=obj[field];for(i=arr.length-1;i>=0;i-=1){if(match(arr[i],value)){(0,_splice.default)(arr).call(arr,i,1);}}};lastStepModifierFunctions.$inc=function(obj,field,value){if(typeof value!=='number'){throw new Error(value+" must be a number");}if(typeof obj[field]!=='number'){if(!_.has(obj,field)){obj[field]=value;}else{throw new Error("Don't use the $inc modifier on non-number fields");}}else{obj[field]+=value;}};lastStepModifierFunctions.$max=function(obj,field,value){if(typeof obj[field]==='undefined'){obj[field]=value;}else if(value>obj[field]){obj[field]=value;}};lastStepModifierFunctions.$min=function(obj,field,value){if(typeof obj[field]==='undefined'){obj[field]=value;}else if(value<obj[field]){obj[field]=value;}};function createModifierFunction(modifier){return function(obj,field,value){let fieldParts=typeof field==='string'?field.split('.'):field;if(fieldParts.length===1){lastStepModifierFunctions[modifier](obj,field,value);}else{if(obj[fieldParts[0]]===undefined){if(modifier==='$unset'){return;}obj[fieldParts[0]]={};}modifierFunctions[modifier](obj[fieldParts[0]],(0,_slice.default)(fieldParts).call(fieldParts,1),value);}};}(0,_forEach.default)(_context11=(0,_keys.default)(lastStepModifierFunctions)).call(_context11,function(modifier){modifierFunctions[modifier]=createModifierFunction(modifier);});function modify(obj,updateQuery){let keys=(0,_keys.default)(updateQuery),firstChars=(0,_map.default)(_).call(_,keys,function(item){return item[0];}),dollarFirstChars=(0,_filter.default)(_).call(_,firstChars,function(c){return c==='$';}),newDoc,modifiers;if((0,_indexOf.default)(keys).call(keys,'id')!==-1&&updateQuery.id!==obj.id){throw new Error("You cannot change a document's id");}if(dollarFirstChars.length!==0&&dollarFirstChars.length!==firstChars.length){throw new Error("You cannot mix modifiers and normal fields");}if(dollarFirstChars.length===0){newDoc=deepCopy(updateQuery);newDoc.id=obj.id;}else{modifiers=_.uniq(keys);newDoc=deepCopy(obj);(0,_forEach.default)(modifiers).call(modifiers,function(m){let keys;if(!modifierFunctions[m]){throw new Error("Unknown modifier "+m);}if(typeof updateQuery[m]!=='object'){throw new Error("Modifier "+m+"'s argument must be an object");}keys=(0,_keys.default)(updateQuery[m]);(0,_forEach.default)(keys).call(keys,function(k){modifierFunctions[m](newDoc,k,updateQuery[m][k]);});});}checkObject(newDoc);if(obj.id!==newDoc.id){throw new Error("You can't change a document's id");}return newDoc;}function getDotValue(obj,field){let fieldParts=typeof field==='string'?field.split('.'):field,i,objs;if(!obj){return undefined;}if(fieldParts.length===0){return obj;}if(fieldParts.length===1){return obj[fieldParts[0]];}if(util.isArray(obj[fieldParts[0]])){i=(0,_parseInt2.default)(fieldParts[1],10);if(typeof i==='number'&&!isNaN(i)){return getDotValue(obj[fieldParts[0]][i],(0,_slice.default)(fieldParts).call(fieldParts,2));}objs=new Array();for(i=0;i<obj[fieldParts[0]].length;i+=1){objs.push(getDotValue(obj[fieldParts[0]][i],(0,_slice.default)(fieldParts).call(fieldParts,1)));}return objs;}else{return getDotValue(obj[fieldParts[0]],(0,_slice.default)(fieldParts).call(fieldParts,1));}}function areThingsEqual(a,b){let aKeys,bKeys,i;if(a===null||typeof a==='string'||typeof a==='boolean'||typeof a==='number'||b===null||typeof b==='string'||typeof b==='boolean'||typeof b==='number'){return a===b;}if(util.isDate(a)||util.isDate(b)){return util.isDate(a)&&util.isDate(b)&&a.getTime()===b.getTime();}if(!(util.isArray(a)&&util.isArray(b))&&(util.isArray(a)||util.isArray(b))||a===undefined||b===undefined){return false;}try{aKeys=(0,_keys.default)(a);bKeys=(0,_keys.default)(b);}catch(e){return false;}if(aKeys.length!==bKeys.length){return false;}for(i=0;i<aKeys.length;i+=1){if((0,_indexOf.default)(bKeys).call(bKeys,aKeys[i])===-1){return false;}if(!areThingsEqual(a[aKeys[i]],b[aKeys[i]])){return false;}}return true;}function areComparable(a,b){if(typeof a!=='string'&&typeof a!=='number'&&!util.isDate(a)&&typeof b!=='string'&&typeof b!=='number'&&!util.isDate(b)){return false;}if(typeof a!==typeof b){return false;}return true;}comparisonFunctions.$lt=function(a,b){return areComparable(a,b)&&a<b;};comparisonFunctions.$lte=function(a,b){return areComparable(a,b)&&a<=b;};comparisonFunctions.$gt=function(a,b){return areComparable(a,b)&&a>b;};comparisonFunctions.$gte=function(a,b){return areComparable(a,b)&&a>=b;};comparisonFunctions.$ne=function(a,b){if(a===undefined){return true;}return!areThingsEqual(a,b);};comparisonFunctions.$in=function(a,b){let i;if(!util.isArray(b)){throw new Error("$in operator called with a non-array");}for(i=0;i<b.length;i+=1){if(areThingsEqual(a,b[i])){return true;}}return false;};comparisonFunctions.$nin=function(a,b){if(!util.isArray(b)){throw new Error("$nin operator called with a non-array");}return!comparisonFunctions.$in(a,b);};comparisonFunctions.$regex=function(a,b){if(!util.isRegExp(b)){throw new Error("$regex operator called with non regular expression");}if(typeof a!=='string'){return false;}else{return b.test(a);}};comparisonFunctions.$exists=function(value,exists){if(exists||exists===''){exists=true;}else{exists=false;}if(value===undefined){return!exists;}else{return exists;}};comparisonFunctions.$size=function(obj,value){if(!util.isArray(obj)){return false;}if(value%1!==0){throw new Error("$size operator called without an integer");}return obj.length==value;};comparisonFunctions.$elemMatch=function(obj,value){if(!util.isArray(obj)){return false;}let i=obj.length;let result=false;while(i--){if(match(obj[i],value)){result=true;break;}}return result;};arrayComparisonFunctions.$size=true;arrayComparisonFunctions.$elemMatch=true;logicalOperators.$or=function(obj,query){let i;if(!util.isArray(query)){throw new Error("$or operator used without an array");}for(i=0;i<query.length;i+=1){if(match(obj,query[i])){return true;}}return false;};logicalOperators.$and=function(obj,query){let i;if(!util.isArray(query)){throw new Error("$and operator used without an array");}for(i=0;i<query.length;i+=1){if(!match(obj,query[i])){return false;}}return true;};logicalOperators.$not=function(obj,query){return!match(obj,query);};logicalOperators.$where=function(obj,fn){let result;if(!_.isFunction(fn)){throw new Error("$where operator used without a function");}result=fn.call(obj);if(!_.isBoolean(result)){throw new Error("$where function must return boolean");}return result;};function match(obj,query){let queryKeys,queryKey,queryValue,i;if(isPrimitiveType(obj)||isPrimitiveType(query)){return matchQueryPart({needAKey:obj},'needAKey',query);}queryKeys=(0,_keys.default)(query);for(i=0;i<queryKeys.length;i+=1){queryKey=queryKeys[i];queryValue=query[queryKey];if(queryKey[0]==='$'){if(!logicalOperators[queryKey]){throw new Error("Unknown logical operator "+queryKey);}if(!logicalOperators[queryKey](obj,queryValue)){return false;}}else{if(!matchQueryPart(obj,queryKey,queryValue)){return false;}}}return true;}function matchQueryPart(obj,queryKey,queryValue,treatObjAsValue){let objValue=getDotValue(obj,queryKey),i,keys,firstChars,dollarFirstChars;if(util.isArray(objValue)&&!treatObjAsValue){if(util.isArray(queryValue)){return matchQueryPart(obj,queryKey,queryValue,true);}if(queryValue!==null&&typeof queryValue==='object'&&!util.isRegExp(queryValue)){keys=(0,_keys.default)(queryValue);for(i=0;i<keys.length;i+=1){if(arrayComparisonFunctions[keys[i]]){return matchQueryPart(obj,queryKey,queryValue,true);}}}for(i=0;i<objValue.length;i+=1){if(matchQueryPart({k:objValue[i]},'k',queryValue)){return true;}}return false;}if(queryValue!==null&&typeof queryValue==='object'&&!util.isRegExp(queryValue)&&!util.isArray(queryValue)){keys=(0,_keys.default)(queryValue);firstChars=(0,_map.default)(_).call(_,keys,function(item){return item[0];});dollarFirstChars=(0,_filter.default)(_).call(_,firstChars,function(c){return c==='$';});if(dollarFirstChars.length!==0&&dollarFirstChars.length!==firstChars.length){throw new Error("You cannot mix operators and normal fields");}if(dollarFirstChars.length>0){for(i=0;i<keys.length;i+=1){if(!comparisonFunctions[keys[i]]){throw new Error("Unknown comparison function "+keys[i]);}if(!comparisonFunctions[keys[i]](objValue,queryValue[keys[i]])){return false;}}return true;}}if(util.isRegExp(queryValue)){return comparisonFunctions.$regex(objValue,queryValue);}if(!areThingsEqual(objValue,queryValue)){return false;}return true;}module.exports.serialize=serialize;module.exports.deserialize=deserialize;module.exports.deepCopy=deepCopy;module.exports.checkObject=checkObject;module.exports.isPrimitiveType=isPrimitiveType;module.exports.modify=modify;module.exports.getDotValue=getDotValue;module.exports.match=match;module.exports.areThingsEqual=areThingsEqual;module.exports.compareThings=compareThings;