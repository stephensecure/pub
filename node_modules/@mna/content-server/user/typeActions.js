"use strict";var _interopRequireDefault=require("@babel/runtime-corejs3/helpers/interopRequireDefault");var _Object$defineProperty2=require("@babel/runtime-corejs3/core-js-stable/object/define-property");_Object$defineProperty2(exports,"__esModule",{value:true});exports.create=create;exports.find=find;exports.findOne=findOne;exports.update=update;exports.remove=remove;exports.login=login;exports.logout=logout;exports.register=register;var _defineProperty2=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/define-property"));var _defineProperties=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/define-properties"));var _getOwnPropertyDescriptors=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptors"));var _forEach=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/for-each"));var _getOwnPropertyDescriptor=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptor"));var _filter=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/filter"));var _getOwnPropertySymbols=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-symbols"));var _keys=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/keys"));var _find=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/find"));var _map=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/map"));var _defineProperty3=_interopRequireDefault(require("@babel/runtime-corejs3/helpers/defineProperty"));var _includes=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/includes"));var _utils=require("./utils");function ownKeys(object,enumerableOnly){var keys=(0,_keys.default)(object);if(_getOwnPropertySymbols.default){var symbols=(0,_getOwnPropertySymbols.default)(object);if(enumerableOnly)symbols=(0,_filter.default)(symbols).call(symbols,function(sym){return(0,_getOwnPropertyDescriptor.default)(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){var _context3;(0,_forEach.default)(_context3=ownKeys(Object(source),true)).call(_context3,function(key){(0,_defineProperty3.default)(target,key,source[key]);});}else if(_getOwnPropertyDescriptors.default){(0,_defineProperties.default)(target,(0,_getOwnPropertyDescriptors.default)(source));}else{var _context4;(0,_forEach.default)(_context4=ownKeys(Object(source))).call(_context4,function(key){(0,_defineProperty2.default)(target,key,(0,_getOwnPropertyDescriptor.default)(source,key));});}}return target;}const log=(...args)=>console.log('@mna/content/user/typeActions',...args);async function hashAndDiscardPassword(auth,data){data.passwordHash=await auth.createHash(data.password);delete data.password;return data;}async function create({auth,store,data={},user,isAllowed,checkSelf}){var _context;data=await hashAndDiscardPassword(auth,data);const role=user&&(0,_includes.default)(_context=user.role).call(_context,'admin')?data.role||'subscriber':'subscriber';const result=(0,_utils.cleanUserData)((await store.create(_objectSpread({},data,{role}))));return{result};}async function find({store,data,user,isAllowed,checkSelf}){var _context2;const result=(0,_map.default)(_context2=(await(0,_find.default)(store).call(store,data))||[]).call(_context2,_utils.cleanUserData);return{result};}async function findOne({store,data,user,isAllowed,checkSelf}){const result=(0,_utils.cleanUserData)((await store.findOne(data))||{});return{result};}async function update({auth,store,data,user,isAllowed,checkSelf}){if(!data.id)throw{message:'Requires ID'};if(!isAllowed)throw{message:'Forbidden'};if(data.password){data=await hashAndDiscardPassword(auth,data);}const result=await store.update(data);return{result};}async function remove({store,data,user,isAllowed,checkSelf}){if(!isAllowed)throw{message:'Forbidden'};const result=await store.remove(data);return{result};}async function login({auth,store,data,req,res}){const{name,password}=data;const user=await store.findOne({name});if(!user||!(await auth.compareHash(password,user.passwordHash))){throw{message:'Login failed'};}await auth.login(req,res,user);return{message:'Login success',result:(0,_utils.cleanUserData)(user)};}async function logout({auth,store,data,req,res}){await auth.logout(req,res);return{message:'Logout success'};}async function register({auth,store,data,res,user,isAllowed,checkSelf}){}