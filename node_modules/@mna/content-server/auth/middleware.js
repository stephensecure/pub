"use strict";var _interopRequireDefault=require("@babel/runtime-corejs3/helpers/interopRequireDefault");var _Object$defineProperty2=require("@babel/runtime-corejs3/core-js-stable/object/define-property");_Object$defineProperty2(exports,"__esModule",{value:true});exports.default=createAuthMiddleware;var _defineProperty2=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/define-property"));var _defineProperties=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/define-properties"));var _getOwnPropertyDescriptors=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptors"));var _forEach=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/for-each"));var _getOwnPropertyDescriptor=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-descriptor"));var _filter=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/instance/filter"));var _getOwnPropertySymbols=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/get-own-property-symbols"));var _keys=_interopRequireDefault(require("@babel/runtime-corejs3/core-js-stable/object/keys"));var _defineProperty3=_interopRequireDefault(require("@babel/runtime-corejs3/helpers/defineProperty"));var _cookie=require("cookie");function ownKeys(object,enumerableOnly){var keys=(0,_keys.default)(object);if(_getOwnPropertySymbols.default){var symbols=(0,_getOwnPropertySymbols.default)(object);if(enumerableOnly)symbols=(0,_filter.default)(symbols).call(symbols,function(sym){return(0,_getOwnPropertyDescriptor.default)(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){var _context;(0,_forEach.default)(_context=ownKeys(Object(source),true)).call(_context,function(key){(0,_defineProperty3.default)(target,key,source[key]);});}else if(_getOwnPropertyDescriptors.default){(0,_defineProperties.default)(target,(0,_getOwnPropertyDescriptors.default)(source));}else{var _context2;(0,_forEach.default)(_context2=ownKeys(Object(source))).call(_context2,function(key){(0,_defineProperty2.default)(target,key,(0,_getOwnPropertyDescriptor.default)(source,key));});}}return target;}const TOKEN_KEY='mna_jwt';const emptyCookie=(0,_cookie.serialize)(TOKEN_KEY,'',{path:'/',maxAge:0});const log=(...args)=>console.log('@mna/content/auth/middleware',...args);async function createAuthMiddleware({auth,stores}){const users=stores.user;const tokenFromUser=async user=>{const sub=user.id;return await auth.encodeToken(sub);};const userFromToken=async token=>{const{sub}=(await auth.decodeToken(token))||{};if(sub)return await users.findOne({id:sub});};const createCookieOptions=req=>{const domain=(req.headers.host||'').split(':')[0];return{path:'/',maxAge:14*24*60*60,domain,sameSite:'strict'};};auth.login=async(req,res,user)=>{const token=await tokenFromUser(user);const cookieOptions=createCookieOptions(req);res.setHeader('Set-Cookie',(0,_cookie.serialize)(TOKEN_KEY,token,cookieOptions));};auth.logout=(req,res)=>{res.setHeader('Set-Cookie',(0,_cookie.serialize)(TOKEN_KEY,'',_objectSpread({},createCookieOptions(req),{maxAge:0})));};return async(req,res)=>{req.context.user=null;let token;if(req.cookies){token=req.cookies[TOKEN_KEY];}else if(req.headers&&req.headers.authorization){token=req.headers.authorization.split(' ')[1];log('Check auth header',token);}if(!token)return;try{const user=await userFromToken(token);if(user){req.context.user=user;}}catch(e){log('Auth token expired or invalid');}};}module.exports=exports.default;